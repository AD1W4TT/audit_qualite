name: ci-pr-php
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: read

jobs:
  lint-test:
    runs-on: [self-hosted, windows, iis-prod]
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          tools: composer

      - name: Show PHP version
        shell: powershell
        run: php -v

      - name: Install dependencies
        shell: powershell
        run: |
          if (Test-Path composer.json) {
            composer install --no-interaction --prefer-dist
          } else {
            Write-Host "composer.json absent, install skip"
          }

      - name: Lint PHP files
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Filter *.php | Where-Object { $_.FullName -notmatch "\\vendor\\" }
          foreach ($f in $files) {
            php -l $f.FullName
            if ($LASTEXITCODE -ne 0) { throw "Lint error: $($f.FullName)" }
          }

      - name: Run tests
        shell: powershell
        run: |
          if (Test-Path vendor/bin/phpunit) {
            php vendor/bin/phpunit --colors=never
          } else {
            Write-Host "phpunit absent, tests skipped"
          }
