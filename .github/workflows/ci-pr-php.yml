name: ci-pr-php
on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint-test:
    runs-on: [self-hosted, windows, iis-prod]
    steps:
      - uses: actions/checkout@v4

      - name: Resolve PHP executable
        shell: powershell
        run: |
          $candidates = @(
            "C:\php-8.3.28-nts-Win32-vs16-x64\php.exe"
          )

          if (Get-Command php -ErrorAction SilentlyContinue) {
            $candidates += (Get-Command php).Source
          }

          $candidates += @(
            "C:\php\php.exe",
            "C:\Program Files\PHP\php.exe",
            "C:\Program Files (x86)\PHP\php.exe"
          )

          $phpExe = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
          if (-not $phpExe) {
            throw "php.exe introuvable sur le runner. Ajouter php au PATH ou definir un chemin standard."
          }

          "PHP_EXE=$phpExe" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - shell: powershell
        run: '& "$env:PHP_EXE" -v'

      - shell: powershell
        run: |
          if (Test-Path composer.json) {
            composer install --no-interaction --prefer-dist
          }

      - shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Filter *.php | Where-Object { $_.FullName -notmatch "\\vendor\\" }
          foreach ($f in $files) {
            & "$env:PHP_EXE" -l $f.FullName
            if ($LASTEXITCODE -ne 0) { throw "Lint error: $($f.FullName)" }
          }

      - shell: powershell
        run: |
          if (Test-Path vendor/bin/phpunit) {
            & "$env:PHP_EXE" vendor/bin/phpunit --colors=never
          } else {
            Write-Host "phpunit absent, tests skipped"
          }




