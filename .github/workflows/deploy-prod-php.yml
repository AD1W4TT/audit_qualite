name: deploy-prod-php
on:
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: deploy-prod-php
  cancel-in-progress: false

jobs:
  gate:
    runs-on: [self-hosted, windows, iis-prod]
    steps:
      - uses: actions/checkout@v4
      - shell: powershell
        run: .\.ci\scripts\assert-pr-gate.ps1 -Owner "${{ github.repository_owner }}" -Repo "${{ github.event.repository.name }}" -Sha "${{ github.sha }}" -Token "${{ github.token }}" -MinApprovals 1 -AllowSelfApproval

  deploy:
    needs: gate
    runs-on: [self-hosted, windows, iis-prod]
    steps:
      - uses: actions/checkout@v4
      - name: Ensure age binary
        shell: powershell
        run: |
          if (Get-Command age -ErrorAction SilentlyContinue) {
            Write-Host "age already available"
            exit 0
          }

          $candidates = @(
            "\\foadsysdev1p\CI\actions-runner\tools\age\age.exe",
            "D:\CI\actions-runner\tools\age\age.exe",
            "C:\CI\actions-runner\tools\age\age.exe"
          )

          $ageExe = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $ageExe) {
            throw "age.exe introuvable. Attendu dans \\foadsysdev1p\CI\actions-runner\tools\age"
          }

          (Split-Path -Parent $ageExe) | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          Write-Host "Using age from $ageExe"
      - name: Resolve AGE key path
        shell: powershell
        run: |
          if (-not [string]::IsNullOrWhiteSpace($env:AGE_KEY_FILE) -and (Test-Path $env:AGE_KEY_FILE)) {
            Write-Host "AGE_KEY_FILE already set"
            exit 0
          }

          $candidates = @(
            "C:\CI\actions-runner\keys\cicd-runner-20260223.key",
            "\\foadsysdev1p\CI\actions-runner\keys\cicd-runner-20260223.key"
          )

          foreach ($c in $candidates) {
            if (Test-Path $c) {
              "AGE_KEY_FILE=$c" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              Write-Host "Using AGE key: $c"
              exit 0
            }
          }

          throw "AGE key introuvable. Definir AGE_KEY_FILE ou placer la cle dans C:\CI\actions-runner\keys"
      - name: Resolve target paths
        shell: powershell
        run: |
          $repo = "${{ github.event.repository.name }}"
          $prod = "${{ vars.PROD_PATH }}"
          if ([string]::IsNullOrWhiteSpace($prod)) { throw "Variable GitHub PROD_PATH obligatoire (chemin IIS deja configure)" }
          $bak = "${{ vars.PROD_BACKUP_PATH }}"
          if ([string]::IsNullOrWhiteSpace($bak)) { throw "Variable GitHub PROD_BACKUP_PATH obligatoire" }
          "DEPLOY_TARGET=$prod" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "DEPLOY_BACKUP=$bak" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Stage files
        shell: powershell
        run: |
          $stage = Join-Path $env:RUNNER_TEMP "php-stage-prod"
          if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
          New-Item -ItemType Directory -Path $stage -Force | Out-Null

          robocopy "$env:GITHUB_WORKSPACE" "$stage" /MIR /XD .git .github .ci tests .vscode .idea /XF .gitignore README.md
          $rc = $LASTEXITCODE
          if ($rc -ge 8) { throw "Staging robocopy error code $rc" }
          if ($rc -ge 1) { Write-Host "Staging robocopy completed with warnings/code $rc" }
          $global:LASTEXITCODE = 0

          if (Test-Path ".\.ci\secrets\database.php.age") {
            .\.ci\scripts\decrypt-age.ps1 -InputFile ".\.ci\secrets\database.php.age" -OutputFile "$stage\config\database.php"
          }
          if (Test-Path ".\.ci\secrets\db.php.age") {
            .\.ci\scripts\decrypt-age.ps1 -InputFile ".\.ci\secrets\db.php.age" -OutputFile "$stage\api\db.php"
          }
          if (Test-Path ".\.ci\secrets\config.php.age") {
            .\.ci\scripts\decrypt-age.ps1 -InputFile ".\.ci\secrets\config.php.age" -OutputFile "$stage\api\config.php"
          }

          "STAGE_PATH=$stage" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - shell: powershell
        run: .\.ci\scripts\deploy-iis.ps1 -Source "$env:STAGE_PATH" -Target "$env:DEPLOY_TARGET" -BackupRoot "$env:DEPLOY_BACKUP" -UseAppOffline








