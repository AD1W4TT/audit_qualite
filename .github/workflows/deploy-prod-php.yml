name: deploy-prod-php
on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: read

concurrency:
  group: deploy-prod-php
  cancel-in-progress: false

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: [self-hosted, windows, iis-prod]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Resolve deploy paths
        shell: powershell
        run: |
          $target = "${{ vars.PROD_PHP_PATH }}"
          if ([string]::IsNullOrWhiteSpace($target)) { $target = "${{ vars.PROD_PATH }}" }

          $backup = "${{ vars.PROD_PHP_BACKUP_PATH }}"
          if ([string]::IsNullOrWhiteSpace($backup)) { $backup = "${{ vars.PROD_BACKUP_PATH }}" }

          if ([string]::IsNullOrWhiteSpace($target)) {
            throw "Variable de deploiement manquante: definir PROD_PHP_PATH ou PROD_PATH"
          }
          if ([string]::IsNullOrWhiteSpace($backup)) {
            throw "Variable de backup manquante: definir PROD_PHP_BACKUP_PATH ou PROD_BACKUP_PATH"
          }

          "DEPLOY_TARGET=$target" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "DEPLOY_BACKUP_ROOT=$backup" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          Write-Host "Deploy target resolved: $target"
          Write-Host "Deploy backup resolved: $backup"

      - name: Resolve PHP executable
        shell: powershell
        run: |
          $candidates = @()
          if ($env:PHP_EXE) { $candidates += $env:PHP_EXE }
          $cmd = Get-Command php -ErrorAction SilentlyContinue
          if ($cmd) { $candidates += $cmd.Source }
          $candidates += "C:\php-8.3.28-nts-Win32-vs16-x64\php.exe"

          $php = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1

          if (-not $php) {
            $phpRoot = Join-Path $env:RUNNER_TEMP "php-8.3.28"
            $phpExe = Join-Path $phpRoot "php.exe"
            if (-not (Test-Path $phpExe)) {
              $zip = Join-Path $env:RUNNER_TEMP "php.zip"
              Invoke-WebRequest -Uri "https://windows.php.net/downloads/releases/php-8.3.28-nts-Win32-vs16-x64.zip" -OutFile $zip
              if (Test-Path $phpRoot) { Remove-Item $phpRoot -Recurse -Force }
              Expand-Archive -Path $zip -DestinationPath $phpRoot -Force
            }
            $php = $phpExe
          }

          if (-not (Test-Path $php)) {
            throw "PHP introuvable et installation automatique echouee."
          }

          "PHP_BIN=$php" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          & $php -v

      - name: Install production dependencies
        shell: powershell
        run: |
          if (-not (Test-Path composer.json)) {
            Write-Host "composer.json absent, install skip"
            exit 0
          }

          $composerCmd = "composer"
          $composer = Get-Command composer -ErrorAction SilentlyContinue
          if (-not $composer) {
            $installer = Join-Path $env:RUNNER_TEMP "composer-setup.php"
            $composerPhar = Join-Path $env:RUNNER_TEMP "composer.phar"
            & "$env:PHP_BIN" -r "copy('https://getcomposer.org/installer', '$installer');"
            & "$env:PHP_BIN" $installer --quiet --install-dir $env:RUNNER_TEMP --filename composer.phar
            $composerCmd = "`"$env:PHP_BIN`" `"$composerPhar`""
          }

          Invoke-Expression "$composerCmd install --no-dev --no-interaction --prefer-dist --optimize-autoloader"

      - name: Verify PHP before deploy
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Filter *.php | Where-Object { $_.FullName -notmatch "\\vendor\\" }
          foreach ($f in $files) {
            & "$env:PHP_BIN" -l $f.FullName
            if ($LASTEXITCODE -ne 0) { throw "Lint error: $($f.FullName)" }
          }
          if (Test-Path vendor/bin/phpunit) {
            & "$env:PHP_BIN" vendor/bin/phpunit --colors=never
          } else {
            Write-Host "phpunit absent, tests skipped"
          }

      - name: Stage files
        shell: powershell
        run: |
          $stage = Join-Path $env:RUNNER_TEMP "php-stage-prod"
          if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
          New-Item -ItemType Directory -Path $stage -Force | Out-Null

          robocopy "$env:GITHUB_WORKSPACE" "$stage" /MIR /XD .git .github tests .vscode .idea /XF .gitignore README.md
          $rc = $LASTEXITCODE
          if ($rc -ge 8) { throw "Staging robocopy error code $rc" }

          Write-Host "Robocopy stage exit code: $rc (treated as success)"
          $global:LASTEXITCODE = 0

          "STAGE_PATH=$stage" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Prepare PROD config
        shell: powershell
        env:
          AGE_KEY_FILE: ${{ vars.AGE_KEY_FILE }}
          AGE_EXE: D:\CI\actions-runner\tools\age\age.exe
        run: |
          $out = "${env:STAGE_PATH}\\api\\db.php"
          $encrypted = "./.ci/secrets/db.php.age"
          $currentProd = Join-Path "$env:DEPLOY_TARGET" "api\\db.php"

          try {
            ./.ci/scripts/decrypt-age.ps1 -InputFile $encrypted -OutputFile $out
            Write-Host "Config PROD decryptee depuis .age"
          }
          catch {
            Write-Warning "Decrypt .age impossible: $($_.Exception.Message)"
            if (Test-Path $currentProd) {
              New-Item -ItemType Directory -Force -Path (Split-Path $out) | Out-Null
              Copy-Item -Path $currentProd -Destination $out -Force
              Write-Host "Fallback: reutilisation de la config db.php deja en production"
              $global:LASTEXITCODE = 0
            }
            else {
              throw "Aucune config exploitable: decrypt KO et fichier prod introuvable ($currentProd)"
            }
          }

          # Neutralise tout code de sortie residuel (ex: age=1) quand le fallback a reussi.
          $global:LASTEXITCODE = 0

      - shell: powershell
        run: ./.ci/scripts/deploy-iis.ps1 -Source "$env:STAGE_PATH" -Target "$env:DEPLOY_TARGET" -BackupRoot "$env:DEPLOY_BACKUP_ROOT" -UseAppOffline

